<%- include('../partials/user/header',{search}) %>

    <div class="container mx-auto px-4 py-8">
        <div class="breadcrumb bg-gray-300 p-3">
            <ol class="flex items-center space-x-2 ">
                <li><a href="/user/home" class="hover:text-green-600">Home</a></li>
                <li><span class="mx-2">/</span></li>
                <li><a href="/user/wishlist" class="hover:text-green-600">Wishlist</a></li>
            </ol>
        </div>
        <h1 class="text-3xl font-bold mb-8">My Wishlist</h1>

        <% if (wishlistItems && wishlistItems.length> 0) { %>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <% wishlistItems.forEach(item=> { %>
                    <div class="product-card relative bg-white rounded-lg shadow-md overflow-hidden" data-product="<%= item.product._id %>">
                        <!-- Wishlist Icon -->
                        <div class="wishlist-icon active" data-product="<%= item.product._id %>"
                            onclick="toggleWishlist(event, '<%= item.product._id %>')">
                            <i class="fas fa-heart"></i>
                        </div>

                        <!-- Product Image -->
                        <a href="/user/product/details/<%= item.product._id %>">
                            <div class="aspect-w-1 aspect-h-1 h-48">
                                <img src="/uploads/product-images/<%= item.product.productImage[0] %>"
                                    alt="<%= item.product.productName %>"
                                    class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
                            </div>
                        </a>

                        <!-- Product Info -->
                        <div class="p-4">
                            <h3
                                class="text-lg font-semibold text-gray-800 truncate hover:text-green-600 transition-colors duration-200">
                                <%= item.product.productName %>
                            </h3>
                            <div class="mt-2 flex items-baseline space-x-2">
                                <span class="text-xl font-bold text-green-600">‚Çπ<%= item.product.discountedPrice %>
                                        </span>
                                <% if (item.product.productOffer> 0) { %>
                                    <span class="text-sm text-gray-500 line-through">‚Çπ<%= item.product.mrp %></span>
                                    <span class="text-sm text-red-500">(<%= item.product.productOffer %>% off)</span>
                                    <% } %>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">
                                Added on <%= new Date(item.addedAt).toLocaleDateString() %>
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <button onclick="moveToCart('<%= item.product._id %>')" 
                                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors duration-200">
                                    Move to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                    <% }); %>
            </div>
            <% } else { %>
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üõçÔ∏è</div>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Your wishlist is empty</h2>
                    <p class="text-gray-500 mb-8">Browse our products and add your favorites to the wishlist!</p>
                    <a href="/user/products"
                        class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors duration-200">
                        Browse Products
                    </a>
                </div>
                <% } %>
    </div>

    <style>
        .wishlist-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            padding: 8px;
            transition: all 0.3s ease;
        }

        .wishlist-icon i {
            color: #666;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .wishlist-icon.active i {
            color: #ff4444;
        }

        .wishlist-icon:hover i {
            color: #ff4444;
        }

        .product-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>

    <script>
        async function toggleWishlist(event, productId) {
            event.preventDefault();
            event.stopPropagation();

            const card = event.currentTarget.closest('.product-card');
            
            try {
                const response = await axios.post('/user/wishlist/add', { productId });

                if (response.data.success) {
                    // Show the message first
                    showToast(response.data.message, 'success');
                    
                    // Then handle the card removal if product was removed
                    if (!response.data.inWishlist) {
                        card.style.opacity = '0';
                        setTimeout(() => {
                            card.remove();
                            // If no more products, refresh to show empty state
                            if (document.querySelectorAll('.product-card').length === 0) {
                                window.location.reload();
                            }
                        }, 300);
                    }
                } else {
                    showToast(response.data.message || 'Error updating wishlist', 'error');
                }
            } catch (error) {
                if (error.response && error.response.status === 401) {
                    window.location.href = '/user/login';
                    return;
                }
                showToast(error.response?.data?.message || 'Error updating wishlist', 'error');
                console.error('Error:', error);
            }
        }

        function showToast(message, type) {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                className: "toastify-custom",
                style: {
                    background: type === 'success' ? "#4CAF50" : "#ff4444",
                    position: "fixed",
                    top: "20px",
                    right: "20px",
                    zIndex: "9999",
                    padding: "12px 24px",
                    minWidth: "200px",
                    borderRadius: "8px",
                    fontSize: "14px",
                    fontWeight: "500"
                }
            }).showToast();
        }

        async function moveToCart(productId) {
            try {
                // First add to cart
                const cartResponse = await fetch('/user/addToCart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId: productId })
                });
                
                const cartResult = await cartResponse.json();
                
                if (cartResult.success) {
                    // Then remove from wishlist
                    const wishlistResponse = await fetch('/user/wishlist/remove', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productId: productId })
                    });
                    
                    const wishlistResult = await wishlistResponse.json();
                    
                    if (wishlistResult.success) {
                        // Remove the product card from the UI
                        const card = document.querySelector(`.product-card[data-product="${productId}"]`);
                        if (card) {
                            card.remove();
                            
                            // Check if wishlist is empty
                            const remainingCards = document.querySelectorAll('.product-card');
                            if (remainingCards.length === 0) {
                                location.reload(); // Reload to show empty wishlist message
                            }
                        }
                        
                        // Show success message
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        });

                        Toast.fire({
                            icon: 'success',
                            title: 'Product moved to cart successfully'
                        });
                    }
                }
            } catch (error) {
                console.error('Error moving to cart:', error);
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });

                Toast.fire({
                    icon: 'error',
                    title: 'Something went wrong! Please try again.'
                });
            }
        }
    </script>

    <!-- %- include('../partials/user/footer') %> -->