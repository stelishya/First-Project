<!-- Header -->
<%- include('../../partials/user/header',{search}) %>

<style>
    .wallet-card {
        background: #fff8f3;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(251, 146, 60, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .wallet-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(251, 146, 60, 0.15);
    }

    .balance-section {
        background: linear-gradient(135deg, #eae8e6 0%, #b6b4b3 100%);
        border: 2px solid #767574;
        color: #333231;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .amount-btn {
        background-color: #fff7ed;
        color: #5a5857;
        transition: all 0.3s ease;
        border: 2px solid #3a3937;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .amount-btn:hover {
        background-color: #ffedd5;
        border-color: #4a4948;
        color: #424241;
        transform: scale(1.05);
    }

    .add-money-btn {
        background-color: #494847;
        color: snow;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .add-money-btn:hover {
        background-color: #767372;
        border-color: #3a3838;
        color: white;
        transform: scale(1.02);
    }

    .input-amount {
        transition: all 0.3s ease;
        border: 2px solid #82807e;
        border-radius: 8px;
        background-color: #fff7ed;
    }

    .input-amount:focus {
        border-color: #3e3d3b;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.2);
    }

    .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
    }

    .toast.success {
        background-color: #84cc16;
        border: 2px solid #65a30d;
    }

    .toast.error {
        background-color: #f87171;
        border: 2px solid #dc2626;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .transaction-card {
        background-color: #fff7ed;
        border: 1px solid #454443;
        transition: all 0.3s ease;
    }

    .transaction-card:hover {
        transform: translateX(5px);
        border-color: #787675;
        background-color: #ffedd5;
    }
</style>

<nav>
    <div class="nav-links">
     <a href="/user/home">
      Home
     </a>
     <span class="divider">
     </span>
     <a href="#">
      Contact
     </a>
     <span class="divider">
     </span>
     <a href="#">
      About
     </a>
     <span class="divider">
     </span>
     <a href="/user/products">
      Products
     </a>
    </div>
   </nav>

<!-- Main Content -->
<main class="flex">
    <!-- Sidebar -->
    <%- include('../../partials/user/dashboard_sideBar') %>

    <!-- Main Section -->
    <section class="p-6 w-4/5" style="background-color: rgb(211, 208, 206);">

        <!-- <div class="wallet-card p-6">
            <nav class="flex mb-4 bg-gray-400 rounded" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="/user/wallet" class="inline-flex items-center text-gray-700 hover:text-white-600">
                            <svg class="w-4 h-4 mr-2 " fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                            </svg>
                            Payments
                        </a>
                    </li>
                    
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-200" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="ml-1 text-gray-500 md:ml-2">Wallet</span> -->


        <div class="wallet-card p-8">
            <div class="balance-section text-center">
                <h2 class="text-2xl font-bold mb-2">Current Balance</h2>
                <div class="text-4xl font-bold text-gray-800 mb-4" id="walletBalance">
                    ₹<%= userWallet ? userWallet.balance.toFixed(2) : '0.00' %>
                </div>

            <!-- </li>
        </ol>
    </nav>
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-700">My Wallet</h2> -->

            </div>
            
            <!-- <div class="grid grid-cols-3 gap-4 mb-8">
                <button onclick="addAmount(100)" class="amount-btn">₹100</button>
                <button onclick="addAmount(500)" class="amount-btn">₹500</button>
                <button onclick="addAmount(1000)" class="amount-btn">₹1000</button>
            </div>
            
            <div class="text-center">
                <input type="number" id="customAmount" placeholder="Enter amount" min="1" 
                    class="p-2 border rounded-lg mb-4 w-48">
                <button onclick="addCustomAmount()" class="add-money-btn px-6 py-3 rounded-lg">
                    Add Money to Wallet
                </button>
            </div> -->

            <!-- Transaction History -->
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                <div class="space-y-4">
                    <% if (transactions && transactions.length > 0) { %>
                        <% transactions.forEach(transaction => { %>
                            <div class="transaction-card p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold"><%= transaction.description %></p>
                                        <p class="text-sm text-gray-500">
                                            <%= new Date(transaction.createdAt).toLocaleDateString('en-US', { 
                                                year: 'numeric', 
                                                month: 'short', 
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            }) %>
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold <%= transaction.type === 'CREDIT' ? 'text-green-600' : 'text-red-600' %>">
                                            <%= transaction.type === 'CREDIT' ? '+' : '-' %>₹<%= transaction.amount.toFixed(2) %>
                                        </p>
                                        <p class="text-sm text-gray-500">Balance: ₹<%= transaction.balance.toFixed(2) %></p>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="text-center text-gray-500">No transactions yet</p>
                    <% } %>
                </div>
            </div>

        </div>
    </section>
</main>

<!-- Toast Container -->
<div id="toast" class="toast"></div>

<!-- Footer -->
<div class="text-center p-5 bg-white">
    <h1 class="text-4xl">CAlliope</h1>
    <h2 class="text-2xl">Inc</h2>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
async function addAmount(amount) {
    try {
        // First create a Razorpay order
        const orderResponse = await fetch('/user/create-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ amount: amount })
        });

        const orderData = await orderResponse.json();
        if (!orderData.success) {
            throw new Error(orderData.message || 'Failed to create order');
        }

        // Initialize Razorpay payment
        const options = {
            key: orderData.key_id,
            amount: orderData.amount,
            currency: "INR",
            name: "CAlliope Wallet",
            description: "Add Money to Wallet",
            order_id: orderData.id,
            handler: async function (response) {
                try {
                    // Verify payment and add money to wallet
                    const verifyResponse = await fetch('/user/wallet/add-money', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: amount,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    });

                    const data = await verifyResponse.json();
                    if (data.success) {
                        // Update wallet balance display
                        document.getElementById('walletBalance').textContent = `₹${data.newBalance.toFixed(2)}`;
                        showToast('Amount added successfully', 'success');
                        
                        // Refresh page after 1 second to update transaction history
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast(data.message || 'Failed to add amount', 'error');
                    }
                } catch (error) {
                    console.error('Payment verification error:', error);
                    showToast('Payment verification failed', 'error');
                }
            },
            prefill: {
                name: "<%= session.username %>",
                email: "<%= session.email %>"
            },
            theme: {
                color: "#3399cc"
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();

        rzp.on('payment.failed', function (response) {
            showToast('Payment failed: ' + response.error.description, 'error');
        });

    } catch (error) {
        console.error('Error:', error);
        showToast('Error initiating payment', 'error');
    }
}

function addCustomAmount() {
    const amount = document.getElementById('customAmount').value;
    if (!amount || amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
    }
    if (amount > 100000) {
        showToast('Amount exceeds maximum limit of ₹1,00,000', 'error');
        return;
    }
    addAmount(Number(amount));
    document.getElementById('customAmount').value = ''; // Clear input after submission
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}

// Add event listener for Enter key on custom amount input
document.getElementById('customAmount').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addCustomAmount();
    }
});
</script>