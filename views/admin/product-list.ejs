<%- include ('../partials/admin/sidebar')%>

<div class="min-h-screen bg-[#f5f5f5] ml-64 p-8" style="background-color: #d1cfcf;">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800">Products</h2>
            <a href="/admin/products/add" class="px-6 py-2.5 bg-[#5a5a5a] text-white rounded-lg hover:bg-gray-700 transition-colors duration-200 flex items-center gap-2 font-medium">
                <span class="text-lg">+</span> Add Product
            </a>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <div class="flex gap-4">
                <input type="text" id="searchInput" placeholder="Search products..." 
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 text-gray-600 placeholder-gray-400">
            </div>
        </div>

        <!-- Messages -->
        <% if (errorMessage) { %>
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 px-6 py-4 rounded-lg relative mb-6" role="alert">
                <%= errorMessage %>
            </div>
        <% } %>
        <% if (successMessage) { %>
            <div class="bg-green-100 border-l-4 border-green-500 text-green-700 px-6 py-4 rounded-lg relative mb-6" role="alert">
                <%= successMessage %>
            </div>
        <% } %>

        <!-- Products Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Product</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">MRP</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Offer</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <% if (products && products.length > 0) { %>
                        <% products.forEach((product) => { %>
                            <tr>
                                <td class="px-8 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="h-10 w-10 flex-shrink-0">
                                            <img class="h-10 w-10 rounded-full object-cover" 
                                                src="/uploads/product-images/<%= product.productImage[0] %>" 
                                                alt="<%= product.productName %>">
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900"><%= product.productName.substring(0, 10) %></div>
                                            <div class="text-sm text-gray-500"><%= product.description.substring(0, 10) %>...</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-8 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900"><%= product.category ? product.category.name : 'N/A' %></div>
                                </td>
                                <td class="px-8 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">₹<%= product.mrp.toLocaleString('en-IN') %></div>
                                    <% if (product.productOffer) { %>
                                        <div class="text-xs text-gray-500">
                                            Final: ₹<%= (product.mrp * (1 - product.productOffer/100)).toLocaleString('en-IN') %>
                                        </div>
                                    <% } %>
                                </td>
                                <td class="px-8 py-4 whitespace-nowrap">
                                    <% if (product.productOffer) { %>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                            <%= product.productOffer %>% OFF
                                        </span>
                                    <% } else { %>
                                        <span class="text-sm text-gray-500">No offer</span>
                                    <% } %>
                                </td>
                                <td class="px-8 py-4 whitespace-nowrap">
                                    <% if (product.quantity > 10) { %>
                                        <span class="text-sm text-green-600 font-medium"><%= product.quantity %></span>
                                    <% } else if (product.quantity > 0) { %>
                                        <span class="text-sm text-orange-600 font-medium">Low: <%= product.quantity %></span>
                                    <% } else { %>
                                        <span class="text-sm text-red-600 font-medium">Out of stock</span>
                                    <% } %>
                                </td>
                                <td class="px-8 py-4 whitespace-nowrap">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        <%= product.isListed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                        <%= product.isListed ? 'Listed' : 'Unlisted' %>
                                    </span>
                                </td>
                                <td class="px-8 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex gap-3">
                                        <a href="/admin/products/edit/<%= product._id %>" 
                                           class="text-indigo-600 hover:text-brown-900">
                                           <i class="fas fa-edit"></i>
                                        </a>
                                        <button onclick="toggleProductStatus('<%= product._id %>', '<%= product.isListed ? 'unlist' : 'list' %>')"
                                            class="<%= product.isListed ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900' %>">
                                            <i class="fas <%= product.isListed ? 'fa-ban' : 'fa-check' %>"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="px-8 py-4 text-center text-gray-500">
                                No products found
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex justify-between items-center w-full">
                        <div>
                            <p class="text-sm text-gray-700">
                                Page <span class="font-medium"><%= currentPage %></span> of
                                <span class="font-medium"><%= totalPages %></span>
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <% if (currentPage > 1) { %>
                                <a href="?page=<%= currentPage - 1 %>" 
                                   class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">
                                    Previous
                                </a>
                            <% } %>
                            <% if (currentPage < totalPages) { %>
                                <a href="?page=<%= currentPage + 1 %>" 
                                   class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50">
                                    Next
                                </a>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
async function toggleProductStatus(productId, action) {
    if (confirm(`Are you sure you want to ${action} this product?`)) {
        try {
            const response = await fetch(`/admin/products/${action}/${productId}`, {
                method: 'PATCH'
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert(errorData.message || 'Failed to update product status');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating product status');
        }
    }
}
</script>

<%- include("../partials/admin/footer") %>