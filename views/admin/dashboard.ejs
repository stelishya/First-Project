<title>
    Dashboard
</title>
<link rel="stylesheet" href="/Admin/css/dashboard.css">

<div>
    <%- include ('../partials/admin/sidebar')%>
    <main class="main-content">
        <header class="header">
            <div><h2 class="text-3xl font-bold text-gray-800">Dashboard</h2></div>
            <div class="search-container">
                <input type="text" placeholder="Search for anything">
                <button>
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <!-- <div class="search-bar">
                <i class="fas fa-search"></i>
                <input placeholder="Search..." type="text">
            </div> -->
            <div class="notifications">
                <i class="fas fa-bell"><span class="badge">4</span></i>
                <i class="fas fa-envelope"><span class="badge">3</span></i>
            </div>
            <div class="user-info">
                <div class="name">Selin Steilshya Oliver<br>
                    <div class="role">Admin</div></div>
                    <img alt="User Avatar" height="40" src="https://storage.googleapis.com/a1aa/image/6Frmd66qfz37V6OkvJHOKto7rafaEUORfStf9uiesPYqTb5eE.jpg" width="40">
            </div>
        </header>
        <div class="content-area">
            <div class="con_tainer mx-auto px-4 py-4">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h1 class="text-2xl font-bold mb-6">Sales Report</h1>
            
                    <!-- Filter Form -->
                    <form id="salesReportForm" class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-300 p-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Period</label>
                            <select name="period" id="period" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="">Custom Range</option>
                                <option value="daily" <%= locals.period === 'daily' ? 'selected' : '' %>>Daily</option>
                                <option value="weekly" <%= locals.period === 'weekly' ? 'selected' : '' %>>Weekly</option>
                                <option value="monthly" <%= locals.period === 'monthly' ? 'selected' : '' %>>Monthly</option>
                                <option value="yearly" <%= locals.period === 'yearly' ? 'selected' : '' %>>Yearly</option>
                            </select>
                        </div>
            
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="startDate" name="startDate" value="<%= locals.startDate %>" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
            
                        <div>
                            <label class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="endDate" name="endDate" value="<%= locals.endDate %>" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
            
                        <div class="flex items-end space-x-2">
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                Generate Report
                            </button>
                        </div>
                    </form>
            
                    <% if (locals.reportData && locals.reportData.summary) { %>
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 bg-gray-300 p-3">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Total Orders</h3>
                            <p class="text-2xl font-bold"><%= reportData.summary.totalOrders %></p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Total Amount</h3>
                            <p class="text-2xl font-bold">₹<%= reportData.summary.netAmount.toFixed(2) %></p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Total Discount</h3>
                            <p class="text-2xl font-bold">₹<%= reportData.summary.totalDiscount.toFixed(2) %></p>
                        </div>
                        <!-- <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold">Net Amount</h3>
                            <p class="text-2xl font-bold">₹<%= reportData.summary.netAmount.toFixed(2) %></p>
                        </div> -->
                    </div>
            
                    <button type="button" onclick="downloadReport('pdf')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                        PDF
                    </button>
                    <button type="button" onclick="downloadReport('excel')" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">
                        Excel
                    </button>
                    <!-- Download Buttons -->
                    <!-- <div class="flex gap-4 mb-8 ">
                        <a href="/admin/download-report?format=pdf&<%= new URLSearchParams(query).toString() %>" 
                           class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                            Download PDF
                        </a>
                        <a href="/admin/download-report?format=excel&<%= new URLSearchParams(query).toString() %>" 
                           class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                            Download Excel
                        </a>
                    </div> -->
            
                    <!-- Orders Table -->
                    <% if (reportData.orders && reportData.orders.length > 0) { %>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MRP</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coupon</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Amount</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <% reportData.orders.forEach(order => { %>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap"><%= order.orderId %></td>
                                    <!-- <td class="px-6 py-4 whitespace-nowrap"><%= order.items.productName%></td> -->
                                    <td class="px-6 py-4 whitespace-nowrap"><%= order.customerName %></td>
                                    <td class="px-6 py-4 whitespace-nowrap"><%= new Date(order.orderDate).toLocaleDateString() %></td>
                                    <td class="px-6 py-4 whitespace-nowrap">₹<%= order.totalAmount.toFixed(2) %></td>
                                    <td class="px-6 py-4 whitespace-nowrap">₹<%= order.discount.toFixed(2) %></td>
                                    <td class="px-6 py-4 whitespace-nowrap">₹<%= order.couponDiscount.toFixed(2) %></td>
                                    <td class="px-6 py-4 whitespace-nowrap">₹<%= order.finalAmount.toFixed(2) %></td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    <% } else { %>
                        <p class="text-center text-gray-500 mt-4">No orders found for the selected period.</p>
                        <% } %>
                    <% } %>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    function initializeFormControls() {
        try{
        const periodSelect = document.getElementById('period');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (!periodSelect || !startDateInput || !endDateInput) {
            console.error('Form elements not found',{
                period: !!periodSelect,
                startDate: !!startDateInput,
                endDate: !!endDateInput
            });
            return;
        }
          // Add change event listener
          periodSelect.addEventListener('change', function() {
            if (this.value) {
                startDateInput.disabled = true;
                endDateInput.disabled = true;
            } else {
                startDateInput.disabled = false;
                endDateInput.disabled = false;
            }
        });

        // Set initial state
        if (periodSelect.value) {
            startDateInput.disabled = true;
            endDateInput.disabled = true;
        }
        console.log('Form controls initialized successfully');
    } catch (error) {
            console.error('Error initializing form controls:', error);
        }
    }


    // document.getElementById('period').addEventListener('change', function() {
    //     const periodSelect = this;
    //     const startDateInput = document.getElementById('startDate');
    //     const endDateInput = document.getElementById('endDate');
        
    //     if (periodSelect.value) {
    //         startDateInput.disabled = true;
    //         endDateInput.disabled = true;
    //     } else {
    //         startDateInput.disabled = false;
    //         endDateInput.disabled = false;
    //     }
    // });
    
    function downloadReport(format) {
        try{
            const form = document.getElementById('salesReportForm');
            if (!form) {
                    console.error('Sales report form not found');
                    return;
                }
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            
            window.location.href = `/admin/download-report?${queryString}&format=${format}`;
        }catch(error){
            console.error('Error downloading report:', error); 
        }
    }
    
    // // Initialize form state
    // document.addEventListener('DOMContentLoaded', function() {
    //     const periodSelect = document.getElementById('period');
    //     const startDateInput = document.getElementById('startDate');
    //     const endDateInput = document.getElementById('endDate');
        
    //     if (periodSelect.value) {
    //         startDateInput.disabled = true;
    //         endDateInput.disabled = true;
    //     }
    // });
    //*************************
    // Initialize form when DOM is fully loaded
    // if (document.readyState === 'loading') {
    //     document.addEventListener('DOMContentLoaded', initializeFormControls);
    // } else {
    //     initializeFormControls();
    // }
    //******************
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing form controls');
        initializeFormControls();
    });
    </script>